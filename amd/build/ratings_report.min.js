define("local_datacurso_ratings/ratings_report",["exports","core/ajax","core/templates","core/notification","core/str"],(function(_exports,_ajax,_templates,_notification,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * General ratings report JS
   *
   * @module     local_datacurso_ratings/ratings_report
   * @copyright  2025 Industria Elearning
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);const init=()=>{const container=document.querySelector("#general-ratings-report-container");if(!container)return;let categories=[];try{categories=JSON.parse(container.dataset.categories||"[]")}catch(e){console.warn("No se pudieron parsear las categorías",e)}!function(container){container.innerHTML='\n        <div class="text-center p-4">\n            <div class="spinner-border text-primary" role="status">\n                <span class="sr-only">Cargando...</span>\n            </div>\n            <p class="mt-2">Cargando reporte general de calificaciones...</p>\n        </div>\n    '}(container),_ajax.default.call([{methodname:"local_datacurso_ratings_get_ratings_report",args:{}}])[0].then((data=>function(data,categories){const courseGroups={};let totalLikes=0,totalDislikes=0,totalActivities=0;data.forEach((activity=>{const courseName=activity.course;courseGroups[courseName]||(courseGroups[courseName]={courseName:courseName,categoryid:activity.categoryid||"",activities:[],courseLikes:0,courseDislikes:0,courseActivities:0});const processedActivity={...activity,total_ratings:activity.likes+activity.dislikes,has_ratings:activity.likes+activity.dislikes>0,has_comments:activity.comments&&activity.comments.length>0,satisfaction_class:getSatisfactionClass(activity.approvalpercent),formatted_percentage:activity.approvalpercent?activity.approvalpercent.toFixed(1)+"%":"0%",comments_count:activity.comments?activity.comments.length:0,comments_text:activity.comments?activity.comments.join(" / "):""};courseGroups[courseName].activities.push(processedActivity),courseGroups[courseName].courseLikes+=activity.likes,courseGroups[courseName].courseDislikes+=activity.dislikes,courseGroups[courseName].courseActivities+=1,totalLikes+=activity.likes,totalDislikes+=activity.dislikes,totalActivities+=1})),Object.keys(courseGroups).forEach((courseName=>{const course=courseGroups[courseName],courseTotal=course.courseLikes+course.courseDislikes;course.courseSatisfaction=courseTotal>0?(course.courseLikes/courseTotal*100).toFixed(1):"0",course.courseSatisfactionClass=getSatisfactionClass(parseFloat(course.courseSatisfaction)),course.courseTotal=courseTotal,course.activities.sort(((a,b)=>b.approvalpercent-a.approvalpercent))}));const coursesArray=Object.values(courseGroups).sort(((a,b)=>b.courseTotal-a.courseTotal)),totalRatings=totalLikes+totalDislikes,overallSatisfaction=totalRatings>0?totalLikes/totalRatings*100:0;return{courses:coursesArray,has_data:coursesArray.length>0,categories:categories,summary:{total_courses:coursesArray.length,total_activities:totalActivities,total_ratings:totalRatings,total_likes:totalLikes,total_dislikes:totalDislikes,overall_satisfaction:overallSatisfaction.toFixed(1),satisfaction_class:getSatisfactionClass(overallSatisfaction),activities_with_ratings:data.filter((a=>a.likes+a.dislikes>0)).length}}}(data,categories))).then((templateData=>_templates.default.render("local_datacurso_ratings/ratings_report_page",templateData))).then(((html,js)=>{container.innerHTML=html,_templates.default.runTemplateJS(js),document.querySelectorAll(".course-toggle").forEach((button=>{button.addEventListener("click",(e=>{const target=button.getAttribute("data-target"),courseContent=document.querySelector(target),icon=button.querySelector("i");courseContent.classList.contains("show")?(courseContent.classList.remove("show"),icon.classList.remove("fa-chevron-down"),icon.classList.add("fa-chevron-right")):(courseContent.classList.add("show"),icon.classList.remove("fa-chevron-right"),icon.classList.add("fa-chevron-down"))}))})),function(){const searchInput=document.querySelector("#activity-search"),courseFilter=document.querySelector("#course-filter"),categoryFilter=document.querySelector("#category-filter");searchInput&&searchInput.addEventListener("input",filterActivities),courseFilter&&courseFilter.addEventListener("input",filterActivities),categoryFilter&&categoryFilter.addEventListener("input",(()=>{const selectedName=categoryFilter.value;let categoryid="";document.querySelector("#categories").querySelectorAll("option").forEach((option=>{option.value===selectedName&&(categoryid=option.getAttribute("data-id")||"")})),categoryFilter.setAttribute("data-category-id",categoryid),filterActivities(),function(categoryid){const courseFilter=document.querySelector("#course-filter"),coursesDatalist=document.querySelector("#courses");courseFilter&&coursesDatalist&&(courseFilter.value="",coursesDatalist.innerHTML='<option value="Todos los cursos">Todos los cursos</option>',""!==categoryid&&_ajax.default.call([{methodname:"local_datacurso_ratings_get_courses_by_category",args:{categoryid:parseInt(categoryid)}}])[0].then((courses=>{courses&&courses.length&&courses.forEach((course=>{const option=document.createElement("option");option.value=course.fullname,option.textContent=course.fullname,coursesDatalist.appendChild(option)}))})).catch(_notification.default.exception))}(categoryid)}))}()})).catch((error=>{console.error("Error loading general ratings report:",error),function(container,error){container.innerHTML='\n        <div class="alert alert-danger">\n            <h4>Error al cargar el reporte</h4>\n            <p>No se pudo cargar la información del reporte general. Por favor, intente nuevamente.</p>\n            <small>Error: '.concat(error.message||"Error desconocido","</small>\n        </div>\n    ")}(container,error)}))};function getSatisfactionClass(percentage){return percentage>=80?"success":percentage>=60?"warning":percentage>=40?"info":"danger"}function filterActivities(){var _document$querySelect,_document$querySelect2;const searchTerm=(null===(_document$querySelect=document.querySelector("#activity-search"))||void 0===_document$querySelect?void 0:_document$querySelect.value.toLowerCase())||"",selectedCourse=(null===(_document$querySelect2=document.querySelector("#course-filter"))||void 0===_document$querySelect2?void 0:_document$querySelect2.value)||"",categoryFilter=document.querySelector("#category-filter"),selectedCategory=(null==categoryFilter?void 0:categoryFilter.getAttribute("data-category-id"))||"";document.querySelectorAll(".course-section").forEach((section=>{const courseId=section.getAttribute("data-course"),categoryId=section.getAttribute("data-category");let courseVisible=!1;!(""===selectedCategory||categoryId===selectedCategory)||""!==selectedCourse&&courseId!==selectedCourse?courseVisible=!1:section.querySelectorAll(".activity-row").forEach((row=>{const activityName=row.getAttribute("data-activity").toLowerCase();""===searchTerm||activityName.includes(searchTerm)?(row.style.display="",courseVisible=!0):row.style.display="none"})),section.style.display=courseVisible?"":"none"}))}_exports.init=init;var _default={init:init};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=ratings_report.min.js.map