{"version":3,"file":"rate.min.js","sources":["../src/rate.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handles rating and feedback interactions for course modules.\n *\n * @module     local_datacurso_ratings/rate\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\n\n/**\n * Initialise rating widget for the given cmid.\n *\n * @param {number} cmid - Course module ID.\n */\nexport const init = (cmid) => {\n    const container = document.querySelector(`.local-dcr-rate[data-cmid=\"${cmid}\"]`);\n    if (!container) {\n        return;\n    }\n\n    const fbBlock = container.querySelector('.local-dcr-feedback');\n    const fbInput = container.querySelector('#local-dcr-feedback-input');\n    const fbTextareaWrap = container.querySelector('#local-dcr-feedback-textarea');\n    const sendBtn = container.querySelector('[data-action=\"send\"]');\n    const cancelBtn = container.querySelector('[data-action=\"cancel\"]');\n    const likeOptions = container.querySelector('.like-options');\n    const dislikeOptions = container.querySelector('.dislike-options');\n    const msgResponse = container.querySelector('.message-response-rate');\n\n    /**\n     * Show element.\n     * @param {HTMLElement} el\n     */\n    const show = (el) => {\n        if (el) {\n            el.style.display = 'block';\n            el.setAttribute('aria-hidden', 'false');\n        }\n    };\n\n    /**\n     * Hide element.\n     * @param {HTMLElement} el\n     */\n    const hide = (el) => {\n        if (el) {\n            el.style.display = 'none';\n            el.setAttribute('aria-hidden', 'true');\n        }\n    };\n\n    /**\n     * Display a feedback message inside the message-response-rate div.\n     * @param {string} message The message text.\n     * @param {string} [type='success'] Message type: success|error.\n     */\n    const showMessage = async(message, type = 'success') => {\n        if (!msgResponse) {\n            return;\n        }\n\n        const htmlMessage = await Templates.render('local_datacurso_ratings/rate_message_response', {message, type});\n\n        msgResponse.innerHTML = htmlMessage;\n    };\n\n    // Handle like/dislike button click.\n    container.querySelectorAll('[data-action=\"rate\"]').forEach((btn) => {\n        btn.addEventListener('click', () => {\n            const rating = parseInt(btn.dataset.rating, 10);\n\n            if (rating === 0) {\n                show(fbBlock);\n                show(dislikeOptions);\n                hide(likeOptions);\n                sendBtn?.setAttribute('data-rating', '0');\n            } else {\n                show(fbBlock);\n                show(likeOptions);\n                hide(dislikeOptions);\n                sendBtn?.setAttribute('data-rating', '1');\n            }\n\n            hide(fbTextareaWrap);\n        });\n    });\n\n    // Show textarea if “Other” is selected.\n    container.querySelectorAll('input[name=\"feedback_choice\"]').forEach((radio) => {\n        radio.addEventListener('change', () => {\n            if (radio.value === 'other' && radio.checked) {\n                show(fbTextareaWrap);\n                fbInput?.focus();\n            } else if (radio.checked) {\n                hide(fbTextareaWrap);\n            }\n        });\n    });\n\n    // Cancel feedback.\n    cancelBtn?.addEventListener('click', () => {\n        hide(fbBlock);\n        hide(fbTextareaWrap);\n        if (fbInput) {\n            fbInput.value = '';\n            fbInput.disabled = false;\n        }\n\n        container.querySelectorAll('input[name=\"feedback_choice\"]').forEach((r) => {\n            r.checked = false;\n            r.disabled = false;\n        });\n\n        sendBtn?.removeAttribute('data-rating');\n        sendBtn.disabled = false;\n        cancelBtn.disabled = false;\n        msgResponse.innerHTML = '';\n    });\n\n    // Send feedback.\n    sendBtn?.addEventListener('click', () => {\n        const rating = parseInt(sendBtn.getAttribute('data-rating') || '0', 10);\n        const selected = container.querySelector('input[name=\"feedback_choice\"]:checked');\n\n        let feedback = '';\n        if (selected) {\n            feedback = selected.value === 'other' ? (fbInput?.value || '').trim() : selected.value;\n        }\n\n        sendRating(cmid, rating, feedback);\n    });\n\n    /**\n     * Send rating to server via Ajax.\n     *\n     * @param {number} cmid\n     * @param {number} rating\n     * @param {string} feedback\n     */\n    const sendRating = (cmid, rating, feedback) => {\n        const requests = Ajax.call([{\n            methodname: 'local_datacurso_ratings_save_rating',\n            args: {cmid, rating, feedback}\n        }]);\n\n        requests[0]\n            .then(async () => {\n                const saved = await getString('ratingsaved', 'local_datacurso_ratings');\n                showMessage(saved, 'success');\n\n                // Disable inputs after sending.\n                container.querySelectorAll('[data-action=\"rate\"]').forEach((btn) => {\n                    btn.disabled = true;\n                });\n                container.querySelectorAll('input[name=\"feedback_choice\"]').forEach((r) => {\n                    r.disabled = true;\n                });\n\n                if (sendBtn) {\n                    sendBtn.disabled = true;\n                }\n                if (cancelBtn) {\n                    cancelBtn.disabled = true;\n                }\n                if (fbInput) {\n                    fbInput.disabled = true;\n                }\n\n                hide(fbBlock);\n                hide(fbTextareaWrap);\n            })\n            .catch((e)=> (Notification.exception(e)));\n    };\n};\n\nexport default {init};\n"],"names":["init","cmid","container","document","querySelector","fbBlock","fbInput","fbTextareaWrap","sendBtn","cancelBtn","likeOptions","dislikeOptions","msgResponse","show","el","style","display","setAttribute","hide","querySelectorAll","forEach","btn","addEventListener","parseInt","dataset","rating","radio","value","checked","focus","disabled","r","removeAttribute","innerHTML","getAttribute","selected","feedback","trim","sendRating","Ajax","call","methodname","args","then","async","message","type","htmlMessage","Templates","render","showMessage","catch","e","Notification","exception"],"mappings":";;;;;;;+OAiCaA,KAAQC,aACXC,UAAYC,SAASC,mDAA4CH,gBAClEC,uBAICG,QAAUH,UAAUE,cAAc,uBAClCE,QAAUJ,UAAUE,cAAc,6BAClCG,eAAiBL,UAAUE,cAAc,gCACzCI,QAAUN,UAAUE,cAAc,wBAClCK,UAAYP,UAAUE,cAAc,0BACpCM,YAAcR,UAAUE,cAAc,iBACtCO,eAAiBT,UAAUE,cAAc,oBACzCQ,YAAcV,UAAUE,cAAc,0BAMtCS,KAAQC,KACNA,KACAA,GAAGC,MAAMC,QAAU,QACnBF,GAAGG,aAAa,cAAe,WAQjCC,KAAQJ,KACNA,KACAA,GAAGC,MAAMC,QAAU,OACnBF,GAAGG,aAAa,cAAe,UAoBvCf,UAAUiB,iBAAiB,wBAAwBC,SAASC,MACxDA,IAAIC,iBAAiB,SAAS,KAGX,IAFAC,SAASF,IAAIG,QAAQC,OAAQ,KAGxCZ,KAAKR,SACLQ,KAAKF,gBACLO,KAAKR,aACLF,MAAAA,SAAAA,QAASS,aAAa,cAAe,OAErCJ,KAAKR,SACLQ,KAAKH,aACLQ,KAAKP,gBACLH,MAAAA,SAAAA,QAASS,aAAa,cAAe,MAGzCC,KAAKX,sBAKbL,UAAUiB,iBAAiB,iCAAiCC,SAASM,QACjEA,MAAMJ,iBAAiB,UAAU,KACT,UAAhBI,MAAMC,OAAqBD,MAAME,SACjCf,KAAKN,gBACLD,MAAAA,SAAAA,QAASuB,SACFH,MAAME,SACbV,KAAKX,sBAMjBE,MAAAA,WAAAA,UAAWa,iBAAiB,SAAS,KACjCJ,KAAKb,SACLa,KAAKX,gBACDD,UACAA,QAAQqB,MAAQ,GAChBrB,QAAQwB,UAAW,GAGvB5B,UAAUiB,iBAAiB,iCAAiCC,SAASW,IACjEA,EAAEH,SAAU,EACZG,EAAED,UAAW,KAGjBtB,MAAAA,SAAAA,QAASwB,gBAAgB,eACzBxB,QAAQsB,UAAW,EACnBrB,UAAUqB,UAAW,EACrBlB,YAAYqB,UAAY,MAI5BzB,MAAAA,SAAAA,QAASc,iBAAiB,SAAS,WACzBG,OAASF,SAASf,QAAQ0B,aAAa,gBAAkB,IAAK,IAC9DC,SAAWjC,UAAUE,cAAc,6CAErCgC,SAAW,GACXD,WACAC,SAA8B,UAAnBD,SAASR,QAAqBrB,MAAAA,eAAAA,QAASqB,QAAS,IAAIU,OAASF,SAASR,OAGrFW,WAAWrC,KAAMwB,OAAQW,mBAUvBE,WAAa,CAACrC,KAAMwB,OAAQW,YACbG,cAAKC,KAAK,CAAC,CACxBC,WAAY,sCACZC,KAAM,CAACzC,KAAAA,KAAMwB,OAAAA,OAAQW,SAAAA,aAGhB,GACJO,MAAKC,WA1FMA,eAAMC,aAASC,4DAAO,cACjClC,yBAICmC,kBAAoBC,mBAAUC,OAAO,gDAAiD,CAACJ,QAAAA,QAASC,KAAAA,OAEtGlC,YAAYqB,UAAYc,YAqFhBG,OADoB,mBAAU,cAAe,2BAC1B,WAGnBhD,UAAUiB,iBAAiB,wBAAwBC,SAASC,MACxDA,IAAIS,UAAW,KAEnB5B,UAAUiB,iBAAiB,iCAAiCC,SAASW,IACjEA,EAAED,UAAW,KAGbtB,UACAA,QAAQsB,UAAW,GAEnBrB,YACAA,UAAUqB,UAAW,GAErBxB,UACAA,QAAQwB,UAAW,GAGvBZ,KAAKb,SACLa,KAAKX,mBAER4C,OAAOC,GAAMC,sBAAaC,UAAUF,uCAIlC,CAACpD,KAAAA"}