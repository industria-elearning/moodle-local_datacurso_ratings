{"version":3,"file":"rate.min.js","sources":["../src/rate.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handles rating and feedback interactions for course modules.\n *\n * @module     local_datacurso_ratings/rate\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport { get_string as getString } from 'core/str';\n\n/**\n * Initialise rating widget for the given cmid.\n * @param {Number} cmid\n */\nexport const init = (cmid) => {\n    const container = document.querySelector(`.local-dcr-rate[data-cmid=\"${cmid}\"]`);\n    if (!container) {\n        return;\n    }\n\n    const fbBlock = container.querySelector('.local-dcr-feedback');\n    const fbInput = container.querySelector('#local-dcr-feedback-input');\n    const fbTextareaWrap = container.querySelector('#local-dcr-feedback-textarea');\n    const sendBtn = container.querySelector('[data-action=\"send\"]');\n    const cancelBtn = container.querySelector('[data-action=\"cancel\"]');\n    const likeOptions = container.querySelector('.like-options');\n    const dislikeOptions = container.querySelector('.dislike-options');\n    const msgResponse = container.querySelector('.message-response-rate');\n\n    const show = el => {\n        if (el) {\n            el.style.display = 'block';\n            el.setAttribute('aria-hidden', 'false');\n        }\n    };\n\n    const hide = el => {\n        if (el) {\n            el.style.display = 'none';\n            el.setAttribute('aria-hidden', 'true');\n        }\n    };\n\n    /**\n     * Display a feedback message inside the message-response-rate div.\n     * @param {String} message The message text.\n     * @param {String} type \"success\" or \"error\".\n     */\n    const showMessage = (message, type = 'success') => {\n        if (!msgResponse) {\n            return;\n        }\n\n        msgResponse.innerHTML = `\n            <div class=\"alert alert-${type === 'success' ? 'success' : 'danger'}\" role=\"alert\" style=\"margin-top:0.5rem;\">\n                ${message}\n            </div>\n        `;\n    };\n\n    // Events for rate ðŸ‘ and ðŸ‘Ž.\n    container.querySelectorAll('[data-action=\"rate\"]').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const rating = parseInt(btn.dataset.rating, 10);\n\n            if (rating === 0) {\n                // Dislike â†’ show dislike options.\n                show(fbBlock);\n                show(dislikeOptions);\n                hide(likeOptions);\n                sendBtn?.setAttribute('data-rating', '0');\n            } else {\n                // Like â†’ show like options.\n                show(fbBlock);\n                show(likeOptions);\n                hide(dislikeOptions);\n                sendBtn?.setAttribute('data-rating', '1');\n            }\n\n            hide(fbTextareaWrap);\n        });\n    });\n\n    // Show textarea if \"Others\".\n    container.querySelectorAll('input[name=\"feedback_choice\"]').forEach(radio => {\n        radio.addEventListener('change', () => {\n            if (radio.value === 'other' && radio.checked) {\n                show(fbTextareaWrap);\n                fbInput?.focus();\n            } else if (radio.checked) {\n                hide(fbTextareaWrap);\n            }\n        });\n    });\n\n    // Cancel feedback.\n    cancelBtn?.addEventListener('click', () => {\n        hide(fbBlock);\n        hide(fbTextareaWrap);\n        if (fbInput) fbInput.value = '';\n\n        container.querySelectorAll('input[name=\"feedback_choice\"]').forEach(r => r.checked = false);\n        sendBtn?.removeAttribute('data-rating');\n        msgResponse.innerHTML = ''; // Clean previous message.\n    });\n\n    // Send feedback.\n    sendBtn?.addEventListener('click', () => {\n        const rating = parseInt(sendBtn.getAttribute('data-rating') || '0', 10);\n        const selected = container.querySelector('input[name=\"feedback_choice\"]:checked');\n\n        let feedback = '';\n        if (selected) {\n            feedback = selected.value === 'other' ? (fbInput?.value || '').trim() : selected.value;\n        }\n\n        sendRating(cmid, rating, feedback);\n    });\n\n    /**\n     * Send rating to server via Ajax.\n     * @param {Number} cmid\n     * @param {Number} rating\n     * @param {String} feedback\n     */\n    function sendRating(cmid, rating, feedback) {\n        Ajax.call([{\n            methodname: 'local_datacurso_ratings_save_rating',\n            args: { cmid, rating, feedback }\n        }])[0]\n            .then(async () => {\n                const saved = await getString('ratingsaved', 'local_datacurso_ratings');\n                showMessage(saved, 'success');\n\n                // Disable inputs after sending.\n                if (container) {\n                    container.querySelectorAll('[data-action=\"rate\"]').forEach(btn => btn.disabled = true);\n                    container.querySelectorAll('input[name=\"feedback_choice\"]').forEach(r => r.disabled = true);\n                    if (sendBtn) sendBtn.disabled = true;\n                    if (cancelBtn) cancelBtn.disabled = true;\n                    if (fbInput) fbInput.disabled = true;\n                }\n\n                hide(fbBlock);\n                hide(fbTextareaWrap);\n                console.log(\"save\")\n            })\n            .catch(async (error) => {\n                console.error(error);\n                const errMsg = await getString('errorrating', 'local_datacurso_ratings');\n                showMessage(errMsg, 'error');\n            });\n    }\n};\n\nexport default { init };\n"],"names":["init","cmid","container","document","querySelector","fbBlock","fbInput","fbTextareaWrap","sendBtn","cancelBtn","likeOptions","dislikeOptions","msgResponse","show","el","style","display","setAttribute","hide","showMessage","message","type","innerHTML","querySelectorAll","forEach","btn","addEventListener","parseInt","dataset","rating","radio","value","checked","focus","r","removeAttribute","getAttribute","selected","feedback","trim","call","methodname","args","then","async","saved","disabled","console","log","catch","error","errMsg","sendRating"],"mappings":";;;;;;;6JA+BaA,KAAQC,aACXC,UAAYC,SAASC,mDAA4CH,gBAClEC,uBAICG,QAAUH,UAAUE,cAAc,uBAClCE,QAAUJ,UAAUE,cAAc,6BAClCG,eAAiBL,UAAUE,cAAc,gCACzCI,QAAUN,UAAUE,cAAc,wBAClCK,UAAYP,UAAUE,cAAc,0BACpCM,YAAcR,UAAUE,cAAc,iBACtCO,eAAiBT,UAAUE,cAAc,oBACzCQ,YAAcV,UAAUE,cAAc,0BAEtCS,KAAOC,KACLA,KACAA,GAAGC,MAAMC,QAAU,QACnBF,GAAGG,aAAa,cAAe,WAIjCC,KAAOJ,KACLA,KACAA,GAAGC,MAAMC,QAAU,OACnBF,GAAGG,aAAa,cAAe,UASjCE,YAAc,SAACC,aAASC,4DAAO,UAC5BT,cAILA,YAAYU,0DAC2B,YAATD,KAAqB,UAAY,gFACrDD,4CAMdlB,UAAUqB,iBAAiB,wBAAwBC,SAAQC,MACvDA,IAAIC,iBAAiB,SAAS,KAGX,IAFAC,SAASF,IAAIG,QAAQC,OAAQ,KAIxChB,KAAKR,SACLQ,KAAKF,gBACLO,KAAKR,aACLF,MAAAA,SAAAA,QAASS,aAAa,cAAe,OAGrCJ,KAAKR,SACLQ,KAAKH,aACLQ,KAAKP,gBACLH,MAAAA,SAAAA,QAASS,aAAa,cAAe,MAGzCC,KAAKX,sBAKbL,UAAUqB,iBAAiB,iCAAiCC,SAAQM,QAChEA,MAAMJ,iBAAiB,UAAU,KACT,UAAhBI,MAAMC,OAAqBD,MAAME,SACjCnB,KAAKN,gBACLD,MAAAA,SAAAA,QAAS2B,SACFH,MAAME,SACbd,KAAKX,sBAMjBE,MAAAA,WAAAA,UAAWiB,iBAAiB,SAAS,KACjCR,KAAKb,SACLa,KAAKX,gBACDD,UAASA,QAAQyB,MAAQ,IAE7B7B,UAAUqB,iBAAiB,iCAAiCC,SAAQU,GAAKA,EAAEF,SAAU,IACrFxB,MAAAA,SAAAA,QAAS2B,gBAAgB,eACzBvB,YAAYU,UAAY,MAI5Bd,MAAAA,SAAAA,QAASkB,iBAAiB,SAAS,WACzBG,OAASF,SAASnB,QAAQ4B,aAAa,gBAAkB,IAAK,IAC9DC,SAAWnC,UAAUE,cAAc,6CAErCkC,SAAW,GACXD,WACAC,SAA8B,UAAnBD,SAASN,QAAqBzB,MAAAA,eAAAA,QAASyB,QAAS,IAAIQ,OAASF,SAASN,gBAYrE9B,KAAM4B,OAAQS,wBACzBE,KAAK,CAAC,CACPC,WAAY,sCACZC,KAAM,CAAEzC,KAAAA,KAAM4B,OAAAA,OAAQS,SAAAA,aACtB,GACCK,MAAKC,gBACIC,YAAc,mBAAU,cAAe,2BAC7C1B,YAAY0B,MAAO,WAGf3C,YACAA,UAAUqB,iBAAiB,wBAAwBC,SAAQC,KAAOA,IAAIqB,UAAW,IACjF5C,UAAUqB,iBAAiB,iCAAiCC,SAAQU,GAAKA,EAAEY,UAAW,IAClFtC,UAASA,QAAQsC,UAAW,GAC5BrC,YAAWA,UAAUqC,UAAW,GAChCxC,UAASA,QAAQwC,UAAW,IAGpC5B,KAAKb,SACLa,KAAKX,gBACLwC,QAAQC,IAAI,WAEfC,OAAML,MAAAA,QACHG,QAAQG,MAAMA,aACRC,aAAe,mBAAU,cAAe,2BAC9ChC,YAAYgC,OAAQ,YAlC5BC,CAAWnD,KAAM4B,OAAQS,8CAuClB,CAAEtC,KAAAA"}