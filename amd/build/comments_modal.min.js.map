{"version":3,"file":"comments_modal.min.js","sources":["../src/comments_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handles the display of comments in a modal window.\n *\n * @module local_datacurso_ratings/comments_modal\n * @copyright 2025 Industria Elearning <info@industriaelearning.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport { get_string as getString } from 'core/str';\n\n/**\n * Initialize comments modal functionality.\n */\nexport const init = () => {\n    // Add click handlers to all \"View Comments\" buttons.\n    document.addEventListener('click', function (e) {\n        if (\n            e.target.classList.contains('view-comments-modal') ||\n            e.target.closest('.view-comments-modal')\n        ) {\n            e.preventDefault();\n            const button = e.target.classList.contains('view-comments-modal')\n                ? e.target\n                : e.target.closest('.view-comments-modal');\n\n            const cmid = button.getAttribute('data-cmid');\n            const activityName = button.getAttribute('data-activity');\n\n            if (cmid) {\n                openCommentsModal(cmid, activityName);\n            }\n        }\n    });\n};\n\n/**\n * Open the comments modal for a specific activity.\n * @param {Number} cmid Course module ID.\n * @param {String} activityName Activity name.\n */\nasync function openCommentsModal(cmid, activityName) {\n    try {\n        const [comments, initialBodyHTML] = await Promise.all([\n            getString('comments', 'local_datacurso_ratings'),\n            Templates.render('local_datacurso_ratings/report_ratings_loading', {})\n        ]);\n\n        const modal = await Modal.create({\n            title: comments + ' : ' + activityName,\n            body: initialBodyHTML,\n            large: true,\n            scrollable: true,\n            removeOnClose: true\n        });\n\n        modal.show();\n\n        loadCommentsData(cmid, 0, '', modal);\n\n        modal.getRoot().on(ModalEvents.hidden, function () {\n            modal.destroy();\n        });\n\n        return modal;\n\n    } catch (err) {\n        Notification.exception(err);\n        return null;\n    }\n}\n\n/**\n * Load comments data for the modal.\n * @param {Number} cmid Course module ID.\n * @param {Number} page Page number.\n * @param {String} search Search text.\n * @param {Object} modal Modal instance.\n */\nfunction loadCommentsData(cmid, page = 0, search = '', modal) {\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_activity_comments',\n        args: {\n            cmid: cmid,\n            page: page,\n            perpage: 20,\n            search: search\n        }\n    }])[0]\n        .then((data) => {\n            return Templates.render('local_datacurso_ratings/comments_modal_content', {\n                ...data,\n                searchterm: search\n            });\n        })\n        .then((html, js) => {\n            modal.setBody(html);\n            Templates.runTemplateJS(js);\n            initModalFeatures(cmid, modal);\n        })\n        .catch((err) => {\n            modal.setBody(Notification.exception(err));\n        });\n}\n\n/**\n * Initialize modal features (search, pagination).\n * @param {Number} cmid Course module ID.\n * @param {Object} modal Modal instance.\n */\nfunction initModalFeatures(cmid, modal) {\n    const modalBody = modal.getBody()[0];\n\n    // Search functionality.\n    const searchInput = modalBody.querySelector('#comments-search');\n    if (searchInput) {\n        let searchTimeout;\n        searchInput.addEventListener('input', function () {\n            clearTimeout(searchTimeout);\n            searchTimeout = setTimeout(() => {\n                const searchTerm = this.value.trim();\n                loadCommentsData(cmid, 0, searchTerm, modal);\n            }, 500);\n        });\n    }\n\n    const clearSearch = modalBody.querySelector('#clear-search');\n    if (clearSearch) {\n        clearSearch.addEventListener('click', function () {\n            searchInput.value = '';\n            loadCommentsData(cmid, 0, '', modal);\n        });\n    }\n\n    modalBody.addEventListener('click', function (e) {\n        if (e.target.classList.contains('comments-pagination')) {\n            e.preventDefault();\n            const page = parseInt(e.target.getAttribute('data-page'));\n            const searchTerm = searchInput ? searchInput.value.trim() : '';\n            loadCommentsData(cmid, page, searchTerm, modal);\n        }\n    });\n\n    modalBody.addEventListener('click', function (e) {\n        if (e.target.classList.contains('keyword-filter')) {\n            e.preventDefault();\n            const keyword = e.target.textContent.trim();\n            if (searchInput) {\n                searchInput.value = keyword;\n                loadCommentsData(cmid, 0, keyword, modal);\n            }\n        }\n    });\n}\n\nexport default { init };\n"],"names":["init","document","addEventListener","e","target","classList","contains","closest","preventDefault","button","cmid","getAttribute","activityName","comments","initialBodyHTML","Promise","all","Templates","render","modal","Modal","create","title","body","large","scrollable","removeOnClose","show","loadCommentsData","getRoot","on","ModalEvents","hidden","destroy","err","exception","openCommentsModal","page","search","call","methodname","args","perpage","then","data","searchterm","html","js","setBody","runTemplateJS","initModalFeatures","catch","Notification","modalBody","getBody","searchInput","querySelector","searchTimeout","clearTimeout","setTimeout","searchTerm","this","value","trim","clearSearch","parseInt","keyword","textContent"],"mappings":";;;;;;;yUAiCaA,KAAO,KAEhBC,SAASC,iBAAiB,SAAS,SAAUC,MAErCA,EAAEC,OAAOC,UAAUC,SAAS,wBAC5BH,EAAEC,OAAOG,QAAQ,wBACnB,CACEJ,EAAEK,uBACIC,OAASN,EAAEC,OAAOC,UAAUC,SAAS,uBACrCH,EAAEC,OACFD,EAAEC,OAAOG,QAAQ,wBAEjBG,KAAOD,OAAOE,aAAa,aAC3BC,aAAeH,OAAOE,aAAa,iBAErCD,qBAYiBA,KAAME,wBAExBC,SAAUC,uBAAyBC,QAAQC,IAAI,EAClD,mBAAU,WAAY,2BACtBC,mBAAUC,OAAO,iDAAkD,MAGjEC,YAAcC,eAAMC,OAAO,CAC7BC,MAAOT,SAAW,MAAQD,aAC1BW,KAAMT,gBACNU,OAAO,EACPC,YAAY,EACZC,eAAe,IAGnBP,MAAMQ,OAENC,iBAAiBlB,KAAM,EAAG,GAAIS,OAE9BA,MAAMU,UAAUC,GAAGC,sBAAYC,QAAQ,WACnCb,MAAMc,aAKZ,MAAOC,kCACQC,UAAUD,KAChB,MAtCCE,CAAkB1B,KAAME,4BAiD/BgB,iBAAiBlB,UAAM2B,4DAAO,EAAGC,8DAAS,GAAInB,2DAC9CoB,KAAK,CAAC,CACPC,WAAY,gDACZC,KAAM,CACF/B,KAAMA,KACN2B,KAAMA,KACNK,QAAS,GACTJ,OAAQA,WAEZ,GACCK,MAAMC,MACI3B,mBAAUC,OAAO,iDAAkD,IACnE0B,KACHC,WAAYP,WAGnBK,MAAK,CAACG,KAAMC,MACT5B,MAAM6B,QAAQF,yBACJG,cAAcF,IACxBG,kBAAkBxC,KAAMS,UAE3BgC,OAAOjB,MACJf,MAAM6B,QAAQI,sBAAajB,UAAUD,kBASxCgB,kBAAkBxC,KAAMS,aACvBkC,UAAYlC,MAAMmC,UAAU,GAG5BC,YAAcF,UAAUG,cAAc,uBACxCD,YAAa,KACTE,cACJF,YAAYrD,iBAAiB,SAAS,WAClCwD,aAAaD,eACbA,cAAgBE,YAAW,WACjBC,WAAaC,KAAKC,MAAMC,OAC9BnC,iBAAiBlB,KAAM,EAAGkD,WAAYzC,SACvC,cAIL6C,YAAcX,UAAUG,cAAc,iBACxCQ,aACAA,YAAY9D,iBAAiB,SAAS,WAClCqD,YAAYO,MAAQ,GACpBlC,iBAAiBlB,KAAM,EAAG,GAAIS,UAItCkC,UAAUnD,iBAAiB,SAAS,SAAUC,MACtCA,EAAEC,OAAOC,UAAUC,SAAS,uBAAwB,CACpDH,EAAEK,uBACI6B,KAAO4B,SAAS9D,EAAEC,OAAOO,aAAa,cACtCiD,WAAaL,YAAcA,YAAYO,MAAMC,OAAS,GAC5DnC,iBAAiBlB,KAAM2B,KAAMuB,WAAYzC,WAIjDkC,UAAUnD,iBAAiB,SAAS,SAAUC,MACtCA,EAAEC,OAAOC,UAAUC,SAAS,kBAAmB,CAC/CH,EAAEK,uBACI0D,QAAU/D,EAAEC,OAAO+D,YAAYJ,OACjCR,cACAA,YAAYO,MAAQI,QACpBtC,iBAAiBlB,KAAM,EAAGwD,QAAS/C,4CAMpC,CAAEnB,KAAAA"}