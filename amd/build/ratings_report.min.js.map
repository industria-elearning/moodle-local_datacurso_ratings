{"version":3,"file":"ratings_report.min.js","sources":["../src/ratings_report.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * General ratings report JS\n *\n * @module     local_datacurso_ratings/ratings_report\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/**\n * Initialize the general ratings report\n */\nexport const init = () => {\n    const container = document.querySelector('#general-ratings-report-container');\n    if (!container) {\n        return;\n    }\n\n    let categories = [];\n    try {\n        categories = JSON.parse(container.dataset.categories || '[]');\n    } catch (e) {\n        Notification.alert('Error', 'Error parsing categories data: ' + e.message, 'OK');\n        return;\n    }\n\n    // Show loading state\n    showLoading(container);\n\n    // Call the web service\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_ratings_report',\n        args: {}\n    }])[0]\n        .then((data) => processGeneralReportData(data, categories))\n        .then((templateData) => Templates.render('local_datacurso_ratings/ratings_report_page', templateData))\n        .then((html, js) => {\n            // Replace loading with actual content\n            container.innerHTML = html;\n            Templates.runTemplateJS(js);\n\n            // Initialize additional functionality\n            initGeneralTableFeatures();\n        })\n        .catch((error) => {\n            Notification.exception(error);\n        });\n};\n\n/**\n * Process the raw data from web service\n * @param {Array} data Raw data from web service\n * @param {Array} categories List of categories from PHP\n * @returns {Object} Processed data for template\n */\nfunction processGeneralReportData(data, categories) {\n    // Group data by course\n    const courseGroups = {};\n    let totalLikes = 0;\n    let totalDislikes = 0;\n    let totalActivities = 0;\n\n    data.forEach((activity) => {\n        const courseName = activity.course || 'Unnamed course';\n\n        if (!courseGroups[courseName]) {\n            courseGroups[courseName] = {\n                courseName: courseName,\n                categoryid: activity.categoryid || '',\n                activities: [],\n                courseLikes: 0,\n                courseDislikes: 0,\n                courseActivities: 0\n            };\n        }\n\n        // Defensive defaults\n        const likes = Number(activity.likes || 0);\n        const dislikes = Number(activity.dislikes || 0);\n        const approvalpercent = Number(activity.approvalpercent || 0);\n        const comments = Array.isArray(activity.comments) ? activity.comments : [];\n\n        // Process individual activity\n        const processedActivity = {\n            ...activity,\n            likes,\n            dislikes,\n            total_ratings: likes + dislikes,\n            has_ratings: (likes + dislikes) > 0,\n            has_comments: comments.length > 0,\n            satisfaction_class: getSatisfactionClass(approvalpercent),\n            formatted_percentage: `${approvalpercent.toFixed(1)}%`,\n            comments_count: comments.length,\n            comments_text: comments.join(' / ')\n        };\n\n        courseGroups[courseName].activities.push(processedActivity);\n        courseGroups[courseName].courseLikes += likes;\n        courseGroups[courseName].courseDislikes += dislikes;\n        courseGroups[courseName].courseActivities += 1;\n\n        // Global totals\n        totalLikes += likes;\n        totalDislikes += dislikes;\n        totalActivities += 1;\n    });\n\n    // Calculate course-level statistics\n    Object.keys(courseGroups).forEach((courseName) => {\n        const course = courseGroups[courseName];\n        const courseTotal = course.courseLikes + course.courseDislikes;\n        course.courseSatisfaction = courseTotal > 0\n            ? ((course.courseLikes / courseTotal) * 100).toFixed(1)\n            : '0';\n        course.courseSatisfactionClass = getSatisfactionClass(parseFloat(course.courseSatisfaction));\n        course.courseTotal = courseTotal;\n\n        // Sort activities by satisfaction percentage (highest first)\n        course.activities.sort((a, b) => b.approvalpercent - a.approvalpercent);\n    });\n\n    // Convert to array and sort courses by total ratings\n    const coursesArray = Object.values(courseGroups).sort((a, b) => b.courseTotal - a.courseTotal);\n\n    const totalRatings = totalLikes + totalDislikes;\n    const overallSatisfaction = totalRatings > 0 ? ((totalLikes / totalRatings) * 100) : 0;\n\n    return {\n        courses: coursesArray,\n        has_data: coursesArray.length > 0,\n        categories,\n        summary: {\n            total_courses: coursesArray.length,\n            total_activities: totalActivities,\n            total_ratings: totalRatings,\n            total_likes: totalLikes,\n            total_dislikes: totalDislikes,\n            overall_satisfaction: overallSatisfaction.toFixed(1),\n            satisfaction_class: getSatisfactionClass(overallSatisfaction),\n            activities_with_ratings: data.filter((a) => (Number(a.likes || 0) + Number(a.dislikes || 0)) > 0).length\n        }\n    };\n}\n\n/**\n * Get CSS class based on satisfaction percentage\n * @param {Number} percentage\n * @returns {String}\n */\nfunction getSatisfactionClass(percentage) {\n    if (percentage >= 80) { return 'success'; }\n    if (percentage >= 60) { return 'warning'; }\n    if (percentage >= 40) { return 'info'; }\n    return 'danger';\n}\n\n/**\n * Display a loading spinner.\n *\n * @param {HTMLElement} container\n */\nexport async function showLoading(container) {\n    const html = await Templates.render('local_datacurso_ratings/report_ratings_loading', {});\n    container.innerHTML = html;\n}\n\n/**\n * Initialize additional table features\n */\nfunction initGeneralTableFeatures() {\n    // Course collapse/expand functionality\n    document.querySelectorAll('.course-toggle').forEach((button) => {\n        button.addEventListener('click', () => {\n            const target = button.getAttribute('data-target');\n            const courseContent = document.querySelector(target);\n            const icon = button.querySelector('i');\n\n            if (!courseContent) { return; }\n\n            if (courseContent.classList.contains('show')) {\n                courseContent.classList.remove('show');\n                if (icon) {\n                    icon.classList.remove('fa-chevron-down');\n                    icon.classList.add('fa-chevron-right');\n                }\n            } else {\n                courseContent.classList.add('show');\n                if (icon) {\n                    icon.classList.remove('fa-chevron-right');\n                    icon.classList.add('fa-chevron-down');\n                }\n            }\n        });\n    });\n\n    // Filter functionality\n    initFilterFeatures();\n}\n\n/**\n * Initialize filter functionality\n */\nfunction initFilterFeatures() {\n    const searchInput = document.querySelector('#activity-search');\n    const courseFilter = document.querySelector('#course-filter');\n    const categoryFilter = document.querySelector('#category-filter');\n\n    if (searchInput) {\n        searchInput.addEventListener('input', filterActivities);\n    }\n\n    if (courseFilter) {\n        courseFilter.addEventListener('input', filterActivities);\n    }\n\n    if (categoryFilter) {\n        categoryFilter.addEventListener('input', () => {\n            const selectedName = categoryFilter.value;\n            let categoryid = '';\n\n            const datalist = document.querySelector('#categories');\n            if (datalist) {\n                const options = datalist.querySelectorAll('option');\n                options.forEach((option) => {\n                    if (option.value === selectedName) {\n                        categoryid = option.getAttribute('data-id') || '';\n                    }\n                });\n            }\n\n            // Store id in dataset (use consistent key)\n            categoryFilter.dataset.categoryId = categoryid;\n\n            filterActivities();\n            updateCoursesByCategory(categoryid);\n        });\n    }\n}\n\n/**\n * Call WS to fetch courses of a category and update the course selector\n * @param {String|Number} categoryid\n */\nfunction updateCoursesByCategory(categoryid) {\n    const courseFilter = document.querySelector('#course-filter');\n    const coursesDatalist = document.querySelector('#courses');\n    if (!courseFilter || !coursesDatalist) {\n        return;\n    }\n\n    courseFilter.value = '';\n\n    if (!categoryid) {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_courses_by_category',\n        args: { categoryid: parseInt(categoryid, 10) }\n    }])[0]\n        .then((courses) => {\n            if (Array.isArray(courses) && courses.length) {\n                courses.forEach((course) => {\n                    const option = document.createElement('option');\n                    option.value = course.fullname;\n                    option.textContent = course.fullname;\n                    coursesDatalist.appendChild(option);\n                });\n            }\n        })\n        .catch((err) => {\n            Notification.exception(err);\n        });\n}\n\n/**\n * Filter activities based on search and course selection\n */\nfunction filterActivities() {\n    const searchTerm = (document.querySelector('#activity-search')?.value || '').toLowerCase();\n    const selectedCourse = document.querySelector('#course-filter')?.value || '';\n    const categoryFilter = document.querySelector('#category-filter');\n    const selectedCategory = categoryFilter?.dataset?.categoryId || '';\n\n    document.querySelectorAll('.course-section').forEach((section) => {\n        const courseId = section.getAttribute('data-course') || '';\n        const categoryId = section.getAttribute('data-category') || '';\n        let courseVisible = false;\n\n        const matchesCategory = selectedCategory === '' || categoryId === selectedCategory;\n\n        if (matchesCategory && (selectedCourse === '' || courseId === selectedCourse)) {\n            section.querySelectorAll('.activity-row').forEach((row) => {\n                const activityName = (row.getAttribute('data-activity') || '').toLowerCase();\n                const matchesSearch = searchTerm === '' || activityName.includes(searchTerm);\n\n                if (matchesSearch) {\n                    row.style.display = '';\n                    courseVisible = true;\n                } else {\n                    row.style.display = 'none';\n                }\n            });\n        } else {\n            courseVisible = false;\n        }\n\n        section.style.display = courseVisible ? '' : 'none';\n    });\n}\n\nexport default { init };\n"],"names":["init","container","document","querySelector","categories","JSON","parse","dataset","e","alert","message","showLoading","call","methodname","args","then","data","courseGroups","totalLikes","totalDislikes","totalActivities","forEach","activity","courseName","course","categoryid","activities","courseLikes","courseDislikes","courseActivities","likes","Number","dislikes","approvalpercent","comments","Array","isArray","processedActivity","total_ratings","has_ratings","has_comments","length","satisfaction_class","getSatisfactionClass","formatted_percentage","toFixed","comments_count","comments_text","join","push","Object","keys","courseTotal","courseSatisfaction","courseSatisfactionClass","parseFloat","sort","a","b","coursesArray","values","totalRatings","overallSatisfaction","courses","has_data","summary","total_courses","total_activities","total_likes","total_dislikes","overall_satisfaction","activities_with_ratings","filter","processGeneralReportData","templateData","Templates","render","html","js","innerHTML","runTemplateJS","querySelectorAll","button","addEventListener","target","getAttribute","courseContent","icon","classList","contains","remove","add","searchInput","courseFilter","categoryFilter","filterActivities","selectedName","value","datalist","option","categoryId","coursesDatalist","parseInt","createElement","fullname","textContent","appendChild","catch","err","exception","updateCoursesByCategory","initFilterFeatures","error","percentage","searchTerm","toLowerCase","selectedCourse","selectedCategory","section","courseId","courseVisible","row","activityName","includes","style","display"],"mappings":"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"}