{"version":3,"file":"ratings_report.min.js","sources":["../src/ratings_report.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module get_ratings_report\n *\n * @module     local_datacurso_ratings/ratings_report\n * @copyright  2025 Industria Elearning <info@industriaelearning.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Initialize the general ratings report\n */\nexport const init = () => {\n    const container = document.querySelector('#general-ratings-report-container');\n    if (!container) {\n        return;\n    }\n\n    // Show loading state\n    showLoading(container);\n\n    // Call the web service\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_ratings_report',\n        args: {}\n    }])[0]\n    .then((data) => {\n        return processGeneralReportData(data);\n    })\n    .then((templateData) => {\n        return Templates.render('local_datacurso_ratings/ratings_report_page', templateData);\n    })\n    .then((html, js) => {\n        // Replace loading with actual content\n        container.innerHTML = html;\n        Templates.runTemplateJS(js);\n        \n        // Initialize additional functionality\n        initGeneralTableFeatures();\n    })\n    .catch((error) => {\n        console.error('Error loading general ratings report:', error);\n        showError(container, error);\n    });\n};\n\n/**\n * Process the raw data from web service\n * @param {Array} data Raw data from web service\n * @returns {Object} Processed data for template\n */\nfunction processGeneralReportData(data) {\n    // Group data by course\n    const courseGroups = {};\n    let totalLikes = 0;\n    let totalDislikes = 0;\n    let totalActivities = 0;\n\n    data.forEach(activity => {\n        const courseName = activity.course;\n        \n        if (!courseGroups[courseName]) {\n            courseGroups[courseName] = {\n                courseName: courseName,\n                activities: [],\n                courseLikes: 0,\n                courseDislikes: 0,\n                courseActivities: 0\n            };\n        }\n\n        // Process individual activity\n        const processedActivity = {\n            ...activity,\n            total_ratings: activity.likes + activity.dislikes,\n            has_ratings: (activity.likes + activity.dislikes) > 0,\n            has_comments: activity.comments && activity.comments.length > 0,\n            satisfaction_class: getSatisfactionClass(activity.approvalpercent),\n            formatted_percentage: activity.approvalpercent ? activity.approvalpercent.toFixed(1) + '%' : '0%',\n            comments_count: activity.comments ? activity.comments.length : 0,\n            comments_text: activity.comments ? activity.comments.join(' / ') : ''\n        };\n\n        courseGroups[courseName].activities.push(processedActivity);\n        courseGroups[courseName].courseLikes += activity.likes;\n        courseGroups[courseName].courseDislikes += activity.dislikes;\n        courseGroups[courseName].courseActivities += 1;\n\n        // Global totals\n        totalLikes += activity.likes;\n        totalDislikes += activity.dislikes;\n        totalActivities += 1;\n    });\n\n    // Calculate course-level statistics\n    Object.keys(courseGroups).forEach(courseName => {\n        const course = courseGroups[courseName];\n        const courseTotal = course.courseLikes + course.courseDislikes;\n        course.courseSatisfaction = courseTotal > 0 ? \n            ((course.courseLikes / courseTotal) * 100).toFixed(1) : '0';\n        course.courseSatisfactionClass = getSatisfactionClass(parseFloat(course.courseSatisfaction));\n        course.courseTotal = courseTotal;\n        \n        // Sort activities by satisfaction percentage (highest first)\n        course.activities.sort((a, b) => b.approvalpercent - a.approvalpercent);\n    });\n\n    // Convert to array and sort courses by total ratings\n    const coursesArray = Object.values(courseGroups).sort((a, b) => b.courseTotal - a.courseTotal);\n\n    const totalRatings = totalLikes + totalDislikes;\n    const overallSatisfaction = totalRatings > 0 ? ((totalLikes / totalRatings) * 100) : 0;\n\n    return {\n        courses: coursesArray,\n        has_data: coursesArray.length > 0,\n        summary: {\n            total_courses: coursesArray.length,\n            total_activities: totalActivities,\n            total_ratings: totalRatings,\n            total_likes: totalLikes,\n            total_dislikes: totalDislikes,\n            overall_satisfaction: overallSatisfaction.toFixed(1),\n            satisfaction_class: getSatisfactionClass(overallSatisfaction),\n            activities_with_ratings: data.filter(a => (a.likes + a.dislikes) > 0).length\n        }\n    };\n}\n\n/**\n * Get CSS class based on satisfaction percentage\n * @param {Number} percentage\n * @returns {String}\n */\nfunction getSatisfactionClass(percentage) {\n    if (percentage >= 80) return 'success';\n    if (percentage >= 60) return 'warning';\n    if (percentage >= 40) return 'info';\n    return 'danger';\n}\n\n/**\n * Show loading state\n * @param {Element} container\n */\nfunction showLoading(container) {\n    container.innerHTML = `\n        <div class=\"text-center p-4\">\n            <div class=\"spinner-border text-primary\" role=\"status\">\n                <span class=\"sr-only\">Cargando...</span>\n            </div>\n            <p class=\"mt-2\">Cargando reporte general de calificaciones...</p>\n        </div>\n    `;\n}\n\n/**\n * Show error message\n * @param {Element} container\n * @param {Object} error\n */\nfunction showError(container, error) {\n    container.innerHTML = `\n        <div class=\"alert alert-danger\">\n            <h4>Error al cargar el reporte</h4>\n            <p>No se pudo cargar la informaci√≥n del reporte general. Por favor, intente nuevamente.</p>\n            <small>Error: ${error.message || 'Error desconocido'}</small>\n        </div>\n    `;\n}\n\n/**\n * Initialize additional table features\n */\nfunction initGeneralTableFeatures() {\n    // Course collapse/expand functionality\n    document.querySelectorAll('.course-toggle').forEach(button => {\n        button.addEventListener('click', (e) => {\n            const target = e.target.getAttribute('data-target');\n            const courseContent = document.querySelector(target);\n            const icon = e.target.querySelector('i');\n            \n            if (courseContent.classList.contains('show')) {\n                courseContent.classList.remove('show');\n                icon.classList.remove('fa-chevron-down');\n                icon.classList.add('fa-chevron-right');\n            } else {\n                courseContent.classList.add('show');\n                icon.classList.remove('fa-chevron-right');\n                icon.classList.add('fa-chevron-down');\n            }\n        });\n    });\n\n    // Comments expand functionality\n    document.querySelectorAll('.expand-general-comments').forEach(button => {\n        button.addEventListener('click', (e) => {\n            const target = e.target.getAttribute('data-target');\n            const commentsDiv = document.querySelector(target);\n            \n            if (commentsDiv.style.display === 'none' || !commentsDiv.style.display) {\n                commentsDiv.style.display = 'block';\n                e.target.textContent = 'Ocultar comentarios';\n            } else {\n                commentsDiv.style.display = 'none';\n                e.target.textContent = 'Ver comentarios (' + e.target.getAttribute('data-count') + ')';\n            }\n        });\n    });\n\n    // Filter functionality\n    initFilterFeatures();\n}\n\n/**\n * Initialize filter functionality\n */\nfunction initFilterFeatures() {\n    const searchInput = document.querySelector('#activity-search');\n    const courseFilter = document.querySelector('#course-filter');\n    \n    if (searchInput) {\n        searchInput.addEventListener('input', filterActivities);\n    }\n    \n    if (courseFilter) {\n        courseFilter.addEventListener('change', filterActivities);\n    }\n}\n\n/**\n * Filter activities based on search and course selection\n */\nfunction filterActivities() {\n    const searchTerm = document.querySelector('#activity-search')?.value.toLowerCase() || '';\n    const selectedCourse = document.querySelector('#course-filter')?.value || '';\n    \n    document.querySelectorAll('.course-section').forEach(section => {\n        const courseName = section.getAttribute('data-course');\n        let courseVisible = false;\n        \n        // Check if course matches filter\n        if (selectedCourse === '' || courseName === selectedCourse) {\n            section.querySelectorAll('.activity-row').forEach(row => {\n                const activityName = row.getAttribute('data-activity').toLowerCase();\n                const matchesSearch = searchTerm === '' || activityName.includes(searchTerm);\n                \n                if (matchesSearch) {\n                    row.style.display = '';\n                    courseVisible = true;\n                } else {\n                    row.style.display = 'none';\n                }\n            });\n        }\n        \n        // Show/hide entire course section\n        section.style.display = courseVisible ? '' : 'none';\n    });\n}\n\nexport default {init};"],"names":["init","container","document","querySelector","innerHTML","showLoading","call","methodname","args","then","data","courseGroups","totalLikes","totalDislikes","totalActivities","forEach","activity","courseName","course","activities","courseLikes","courseDislikes","courseActivities","processedActivity","total_ratings","likes","dislikes","has_ratings","has_comments","comments","length","satisfaction_class","getSatisfactionClass","approvalpercent","formatted_percentage","toFixed","comments_count","comments_text","join","push","Object","keys","courseTotal","courseSatisfaction","courseSatisfactionClass","parseFloat","sort","a","b","coursesArray","values","totalRatings","overallSatisfaction","courses","has_data","summary","total_courses","total_activities","total_likes","total_dislikes","overall_satisfaction","activities_with_ratings","filter","processGeneralReportData","templateData","Templates","render","html","js","runTemplateJS","querySelectorAll","button","addEventListener","e","target","getAttribute","courseContent","icon","classList","contains","remove","add","commentsDiv","style","display","textContent","searchInput","courseFilter","filterActivities","initFilterFeatures","catch","error","console","message","showError","percentage","searchTerm","value","toLowerCase","selectedCourse","section","courseVisible","row","activityName","includes"],"mappings":"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"}