{"version":3,"file":"ratings_report.min.js","sources":["../src/ratings_report.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * General ratings report JS\n *\n * @module     local_datacurso_ratings/ratings_report\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable */\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport { get_string as getString } from 'core/str';\n\n/**\n * Initialize the general ratings report\n */\nexport const init = () => {\n    const container = document.querySelector('#general-ratings-report-container');\n    if (!container) {\n        return;\n    }\n\n    // Leer categorías desde el data-attribute\n    let categories = [];\n    try {\n        categories = JSON.parse(container.dataset.categories || '[]');\n    } catch (e) {\n        console.warn(\"No se pudieron parsear las categorías\", e);\n    }\n\n    // Show loading state\n    showLoading(container);\n\n    // Call the web service\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_ratings_report',\n        args: {}\n    }])[0]\n        .then((data) => {\n            return processGeneralReportData(data, categories);\n        })\n        .then((templateData) => {\n            return Templates.render('local_datacurso_ratings/ratings_report_page', templateData);\n        })\n        .then((html, js) => {\n            // Replace loading with actual content\n            container.innerHTML = html;\n            Templates.runTemplateJS(js);\n\n            // Initialize additional functionality\n            initGeneralTableFeatures();\n        })\n        .catch((error) => {\n            console.error('Error loading general ratings report:', error);\n            showError(container, error);\n        });\n};\n\n/**\n * Process the raw data from web service\n * @param {Array} data Raw data from web service\n * @param {Array} categories List of categories from PHP\n * @returns {Object} Processed data for template\n */\nfunction processGeneralReportData(data, categories) {\n    // Group data by course\n    const courseGroups = {};\n    let totalLikes = 0;\n    let totalDislikes = 0;\n    let totalActivities = 0;\n\n    data.forEach(activity => {\n        const courseName = activity.course;\n\n        if (!courseGroups[courseName]) {\n            courseGroups[courseName] = {\n                courseName: courseName,\n                categoryid: activity.categoryid || '', // <= importante para filtro\n                activities: [],\n                courseLikes: 0,\n                courseDislikes: 0,\n                courseActivities: 0\n            };\n        }\n\n        // Process individual activity\n        const processedActivity = {\n            ...activity,\n            total_ratings: activity.likes + activity.dislikes,\n            has_ratings: (activity.likes + activity.dislikes) > 0,\n            has_comments: activity.comments && activity.comments.length > 0,\n            satisfaction_class: getSatisfactionClass(activity.approvalpercent),\n            formatted_percentage: activity.approvalpercent ? activity.approvalpercent.toFixed(1) + '%' : '0%',\n            comments_count: activity.comments ? activity.comments.length : 0,\n            comments_text: activity.comments ? activity.comments.join(' / ') : ''\n        };\n\n        courseGroups[courseName].activities.push(processedActivity);\n        courseGroups[courseName].courseLikes += activity.likes;\n        courseGroups[courseName].courseDislikes += activity.dislikes;\n        courseGroups[courseName].courseActivities += 1;\n\n        // Global totals\n        totalLikes += activity.likes;\n        totalDislikes += activity.dislikes;\n        totalActivities += 1;\n    });\n\n    // Calculate course-level statistics\n    Object.keys(courseGroups).forEach(courseName => {\n        const course = courseGroups[courseName];\n        const courseTotal = course.courseLikes + course.courseDislikes;\n        course.courseSatisfaction = courseTotal > 0 ?\n            ((course.courseLikes / courseTotal) * 100).toFixed(1) : '0';\n        course.courseSatisfactionClass = getSatisfactionClass(parseFloat(course.courseSatisfaction));\n        course.courseTotal = courseTotal;\n\n        // Sort activities by satisfaction percentage (highest first)\n        course.activities.sort((a, b) => b.approvalpercent - a.approvalpercent);\n    });\n\n    // Convert to array and sort courses by total ratings\n    const coursesArray = Object.values(courseGroups).sort((a, b) => b.courseTotal - a.courseTotal);\n\n    const totalRatings = totalLikes + totalDislikes;\n    const overallSatisfaction = totalRatings > 0 ? ((totalLikes / totalRatings) * 100) : 0;\n\n    return {\n        courses: coursesArray,\n        has_data: coursesArray.length > 0,\n        categories: categories, // <= aquí se pasa al mustache\n        summary: {\n            total_courses: coursesArray.length,\n            total_activities: totalActivities,\n            total_ratings: totalRatings,\n            total_likes: totalLikes,\n            total_dislikes: totalDislikes,\n            overall_satisfaction: overallSatisfaction.toFixed(1),\n            satisfaction_class: getSatisfactionClass(overallSatisfaction),\n            activities_with_ratings: data.filter(a => (a.likes + a.dislikes) > 0).length\n        }\n    };\n}\n\n/**\n * Get CSS class based on satisfaction percentage\n * @param {Number} percentage\n * @returns {String}\n */\nfunction getSatisfactionClass(percentage) {\n    if (percentage >= 80) return 'success';\n    if (percentage >= 60) return 'warning';\n    if (percentage >= 40) return 'info';\n    return 'danger';\n}\n\n/**\n * Show loading state\n * @param {Element} container\n */\nfunction showLoading(container) {\n    container.innerHTML = `\n        <div class=\"text-center p-4\">\n            <div class=\"spinner-border text-primary\" role=\"status\">\n                <span class=\"sr-only\">Cargando...</span>\n            </div>\n            <p class=\"mt-2\">Cargando reporte general de calificaciones...</p>\n        </div>\n    `;\n}\n\n/**\n * Show error message\n * @param {Element} container\n * @param {Object} error\n */\nfunction showError(container, error) {\n    container.innerHTML = `\n        <div class=\"alert alert-danger\">\n            <h4>Error al cargar el reporte</h4>\n            <p>No se pudo cargar la información del reporte general. Por favor, intente nuevamente.</p>\n            <small>Error: ${error.message || 'Error desconocido'}</small>\n        </div>\n    `;\n}\n\n/**\n * Initialize additional table features\n */\nfunction initGeneralTableFeatures() {\n    // Course collapse/expand functionality\n    document.querySelectorAll('.course-toggle').forEach(button => {\n        button.addEventListener('click', (e) => {\n            const target = button.getAttribute('data-target');\n            const courseContent = document.querySelector(target);\n            const icon = button.querySelector('i');\n\n            if (courseContent.classList.contains('show')) {\n                courseContent.classList.remove('show');\n                icon.classList.remove('fa-chevron-down');\n                icon.classList.add('fa-chevron-right');\n            } else {\n                courseContent.classList.add('show');\n                icon.classList.remove('fa-chevron-right');\n                icon.classList.add('fa-chevron-down');\n            }\n        });\n    });\n\n    // Filter functionality\n    initFilterFeatures();\n}\n\n/**\n * Initialize filter functionality\n */\nfunction initFilterFeatures() {\n    const searchInput = document.querySelector('#activity-search');\n    const courseFilter = document.querySelector('#course-filter');\n    const categoryFilter = document.querySelector('#category-filter');\n\n    if (searchInput) {\n        searchInput.addEventListener('input', filterActivities);\n    }\n\n    if (courseFilter) {\n        courseFilter.addEventListener('input', filterActivities);\n    }\n\n    if (categoryFilter) {\n        categoryFilter.addEventListener('input', () => {\n            // Obtener el ID de la categoría seleccionada\n            const selectedName = categoryFilter.value;\n            let categoryid = '';\n            \n            // Buscar el ID correspondiente al nombre seleccionado\n            const datalist = document.querySelector('#categories');\n            const options = datalist.querySelectorAll('option');\n            \n            options.forEach(option => {\n                if (option.value === selectedName) {\n                    categoryid = option.getAttribute('data-id') || '';\n                }\n            });\n            \n            // Guardar el ID en un data attribute\n            categoryFilter.setAttribute('data-category-id', categoryid);\n            \n            // 1. Filtrar actividades\n            filterActivities();\n            \n            // 2. Cargar cursos por categoría seleccionada\n            updateCoursesByCategory(categoryid);\n        });\n    }\n}\n\n/**\n * Llama al WS para traer cursos de una categoría y actualizar el selector de cursos\n * @param {String|Number} categoryid\n */\nfunction updateCoursesByCategory(categoryid) {\n    const courseFilter = document.querySelector('#course-filter');\n    const coursesDatalist = document.querySelector('#courses');\n    \n    if (!courseFilter || !coursesDatalist) {\n        return;\n    }\n\n    // Limpiar el input y datalist\n    courseFilter.value = '';\n    coursesDatalist.innerHTML = '<option value=\"Todos los cursos\">Todos los cursos</option>';\n\n    if (categoryid === '') {\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_courses_by_category',\n        args: { categoryid: parseInt(categoryid) }\n    }])[0]\n    .then((courses) => {\n        if (courses && courses.length) {\n            courses.forEach(course => {\n                const option = document.createElement('option');\n                option.value = course.fullname;\n                option.textContent = course.fullname;\n                coursesDatalist.appendChild(option);\n            });\n        }\n    })\n    .catch(Notification.exception);\n}\n\n/**\n * Filter activities based on search and course selection\n */\nfunction filterActivities() {\n    const searchTerm = document.querySelector('#activity-search')?.value.toLowerCase() || '';\n    const selectedCourse = document.querySelector('#course-filter')?.value || '';\n    const categoryFilter = document.querySelector('#category-filter');\n    const selectedCategory = categoryFilter?.getAttribute('data-category-id') || '';\n\n    document.querySelectorAll('.course-section').forEach(section => {\n        const courseId = section.getAttribute('data-course');\n        const categoryId = section.getAttribute('data-category');\n        let courseVisible = false;\n\n        // Verificar categoría\n        const matchesCategory = selectedCategory === '' || categoryId === selectedCategory;\n\n        if (matchesCategory && (selectedCourse === '' || courseId === selectedCourse)) {\n            // courseId y selectedCourse son strings con el nombre del curso\n\n            section.querySelectorAll('.activity-row').forEach(row => {\n                const activityName = row.getAttribute('data-activity').toLowerCase();\n                const matchesSearch = searchTerm === '' || activityName.includes(searchTerm);\n\n                if (matchesSearch) {\n                    row.style.display = '';\n                    courseVisible = true;\n                } else {\n                    row.style.display = 'none';\n                }\n            });\n        } else {\n            courseVisible = false;\n        }\n\n        section.style.display = courseVisible ? '' : 'none';\n    });\n}\n\nexport default { init };\n"],"names":["init","container","document","querySelector","categories","JSON","parse","dataset","e","console","warn","innerHTML","showLoading","call","methodname","args","then","data","courseGroups","totalLikes","totalDislikes","totalActivities","forEach","activity","courseName","course","categoryid","activities","courseLikes","courseDislikes","courseActivities","processedActivity","total_ratings","likes","dislikes","has_ratings","has_comments","comments","length","satisfaction_class","getSatisfactionClass","approvalpercent","formatted_percentage","toFixed","comments_count","comments_text","join","push","Object","keys","courseTotal","courseSatisfaction","courseSatisfactionClass","parseFloat","sort","a","b","coursesArray","values","totalRatings","overallSatisfaction","courses","has_data","summary","total_courses","total_activities","total_likes","total_dislikes","overall_satisfaction","activities_with_ratings","filter","processGeneralReportData","templateData","Templates","render","html","js","runTemplateJS","querySelectorAll","button","addEventListener","target","getAttribute","courseContent","icon","classList","contains","remove","add","searchInput","courseFilter","categoryFilter","filterActivities","selectedName","value","option","setAttribute","coursesDatalist","parseInt","createElement","fullname","textContent","appendChild","catch","Notification","exception","updateCoursesByCategory","initFilterFeatures","error","message","showError","percentage","searchTerm","toLowerCase","selectedCourse","selectedCategory","section","courseId","categoryId","courseVisible","row","activityName","includes","style","display"],"mappings":"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"}