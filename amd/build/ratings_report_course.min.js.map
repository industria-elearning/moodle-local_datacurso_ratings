{"version":3,"file":"ratings_report_course.min.js","sources":["../src/ratings_report_course.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Displays and manages the AI-powered ratings report for a course.\n *\n * @module     local_datacurso_ratings/ratings_report_course\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/**\n * Initialize the ratings report for a specific course.\n *\n * @param {number} courseid\n */\nexport const init = (courseid) => {\n    const container = document.querySelector('#ratings-report-container');\n    if (!container) {\n        return;\n    }\n\n    showLoading(container);\n\n    Ajax.call([{\n        methodname: 'local_datacurso_ratings_get_ratings_report_course',\n        args: {courseid}\n    }])[0]\n        .then((data) => processReportData(data, courseid))\n        .then((templateData) => Templates.render('local_datacurso_ratings/report_ratings_course', templateData))\n        .then((html, js) => {\n            container.innerHTML = html;\n            Templates.runTemplateJS(js);\n            initTableFeatures();\n        })\n        .catch((error) => {\n            Notification.exception(error);\n        });\n};\n\n/**\n * Process raw report data into a template-friendly format.\n *\n * @param {Array} data - Raw WS data.\n * @param {number} courseid - Course ID.\n * @returns {Object}\n */\nfunction processReportData(data, courseid) {\n    let totalLikes = 0;\n    let totalDislikes = 0;\n    let activitiesWithRatings = 0;\n\n    const processedActivities = data.map((item) => {\n        const likes = item.likes || 0;\n        const dislikes = item.dislikes || 0;\n        const totalRatings = likes + dislikes;\n\n        totalLikes += likes;\n        totalDislikes += dislikes;\n        if (totalRatings > 0) {\n            activitiesWithRatings++;\n        }\n\n        const porcentaje = item.approvalpercent || 0;\n        const comentariosArray = Array.isArray(item.comments) ? item.comments : [];\n        const comentarios = comentariosArray.join(' / ');\n\n        return {\n            curso: item.course || '',\n            actividad: item.activity || '',\n            modulo: item.modname || '',\n            cmid: item.cmid || 0,\n            url: item.url || '',\n            likes,\n            dislikes,\n            porcentaje,\n            comentarios,\n            total_ratings: totalRatings,\n            has_ratings: totalRatings > 0,\n            has_comments: comentariosArray.length > 0,\n            satisfaction_class: getSatisfactionClass(porcentaje),\n            formatted_percentage: `${porcentaje.toFixed(1)}%`,\n            activityurl: item.url || `${M.cfg.wwwroot}/mod/${item.modname}/view.php?id=${item.cmid}`\n        };\n    });\n\n    const totalRatings = totalLikes + totalDislikes;\n    const overallSatisfaction = totalRatings > 0 ? ((totalLikes / totalRatings) * 100) : 0;\n\n    return {\n        courseid,\n        activities: processedActivities,\n        has_data: processedActivities.length > 0,\n        summary: {\n            total_activities: processedActivities.length,\n            activities_with_ratings: activitiesWithRatings,\n            total_ratings: totalRatings,\n            total_likes: totalLikes,\n            total_dislikes: totalDislikes,\n            overall_satisfaction: overallSatisfaction.toFixed(1),\n            satisfaction_class: getSatisfactionClass(overallSatisfaction)\n        }\n    };\n}\n\n/**\n * Get Bootstrap color class based on satisfaction percentage.\n *\n * @param {number} percentage\n * @returns {string}\n */\nfunction getSatisfactionClass(percentage) {\n    if (percentage >= 80) {\n        return 'success';\n    }\n    if (percentage >= 60) {\n        return 'warning';\n    }\n    return 'danger';\n}\n\n/**\n * Display a loading spinner.\n *\n * @param {HTMLElement} container\n */\nexport async function showLoading(container) {\n    const html = await Templates.render('local_datacurso_ratings/report_ratings_loading', {});\n    container.innerHTML = html;\n}\n\n\n/**\n * Initialize interactive features in the rendered table.\n */\nfunction initTableFeatures() {\n    document.querySelectorAll('.expand-comments').forEach((button) => {\n        button.addEventListener('click', (e) => {\n            const targetSelector = e.currentTarget.getAttribute('data-target');\n            const commentsDiv = document.querySelector(targetSelector);\n            if (!commentsDiv) {\n                return;\n            }\n\n            const isHidden = commentsDiv.style.display === 'none' || !commentsDiv.style.display;\n            commentsDiv.style.display = isHidden ? 'block' : 'none';\n            e.currentTarget.textContent = isHidden ? 'Ocultar comentarios' : 'Ver comentarios';\n        });\n    });\n\n    initTableSorting();\n}\n\n/**\n * Initialize sorting on table headers.\n */\nfunction initTableSorting() {\n    const headers = document.querySelectorAll('th[data-sort]');\n    headers.forEach((header) => {\n        header.style.cursor = 'pointer';\n        header.addEventListener('click', () => {\n            const sortBy = header.getAttribute('data-sort');\n            sortTable(sortBy, header);\n        });\n    });\n}\n\n/**\n * Basic table sorting handler.\n *\n * @param {string} column - The column key to sort by.\n * @param {HTMLElement} header - The clicked header element.\n */\nfunction sortTable(column, header) {\n    const table = header.closest('table');\n    const tbody = table?.querySelector('tbody');\n    if (!tbody) {\n        return;\n    }\n\n    const rows = Array.from(tbody.querySelectorAll('tr'));\n    const ascending = !header.classList.contains('sorted-asc');\n\n    table.querySelectorAll('th[data-sort]').forEach((h) => h.classList.remove('sorted-asc', 'sorted-desc'));\n    header.classList.add(ascending ? 'sorted-asc' : 'sorted-desc');\n\n    rows.sort((a, b) => {\n        const aValue = a.dataset[column] || '';\n        const bValue = b.dataset[column] || '';\n        return ascending\n            ? aValue.localeCompare(bValue, undefined, {numeric: true})\n            : bValue.localeCompare(aValue, undefined, {numeric: true});\n    });\n\n    rows.forEach((row) => tbody.appendChild(row));\n}\n\nexport default {init};\n"],"names":["init","courseid","container","document","querySelector","showLoading","call","methodname","args","then","data","totalLikes","totalDislikes","activitiesWithRatings","processedActivities","map","item","likes","dislikes","totalRatings","porcentaje","approvalpercent","comentariosArray","Array","isArray","comments","comentarios","join","curso","course","actividad","activity","modulo","modname","cmid","url","total_ratings","has_ratings","has_comments","length","satisfaction_class","getSatisfactionClass","formatted_percentage","toFixed","activityurl","M","cfg","wwwroot","overallSatisfaction","activities","has_data","summary","total_activities","activities_with_ratings","total_likes","total_dislikes","overall_satisfaction","processReportData","templateData","Templates","render","html","js","innerHTML","runTemplateJS","querySelectorAll","forEach","button","addEventListener","e","targetSelector","currentTarget","getAttribute","commentsDiv","isHidden","style","display","textContent","header","cursor","column","table","closest","tbody","rows","from","ascending","classList","contains","h","remove","add","sort","a","b","aValue","dataset","bValue","localeCompare","undefined","numeric","row","appendChild","sortTable","catch","error","exception","percentage"],"mappings":"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"}